<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marp Presentation Editor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
        }

        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .file-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-controls button {
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .file-controls button:hover {
            background: #0056b3;
        }

        .file-controls input[type="file"] {
            font-size: 12px;
        }

        .slides-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .slide-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }

        .slide-item:hover {
            background: #e9ecef;
        }

        .slide-item.active {
            background: #e7f3ff;
            border-color: #007bff;
        }

        .slide-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .slide-item.drag-over {
            border-color: #28a745;
            border-style: dashed;
        }

        .slide-item-number {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .slide-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .slide-item-class {
            font-size: 11px;
            color: #666;
            font-family: monospace;
        }

        .add-slide-btn {
            margin: 10px;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .add-slide-btn:hover {
            background: #218838;
        }

        /* Main editor */
        .main-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .editor-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h2 {
            font-size: 20px;
            color: #333;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .editor-actions button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .editor-actions button.delete {
            background: #dc3545;
        }

        .editor-actions button:hover {
            opacity: 0.9;
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .bullet-list {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: #fafafa;
        }

        .bullet-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bullet-item input {
            flex: 1;
        }

        .bullet-item button {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-bullet-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .markdown-preview {
            margin-top: 20px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üìä Presentation</h1>
                <div class="file-controls">
                    <input type="file" id="file-input" accept=".md" style="display: none;">
                    <button onclick="loadFile()">üìÇ Open Presentation</button>
                    <button onclick="saveFile()">üíæ Save Presentation</button>
                </div>
            </div>
            <div class="slides-list" id="slides-list">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <p>Load a presentation or add a slide</p>
                </div>
            </div>
            <button class="add-slide-btn" onclick="addNewSlide()">+ New Slide</button>
        </div>

        <!-- Main Editor -->
        <div class="main-editor">
            <div id="editor-view">
                <div class="empty-state">
                    <div class="empty-state-icon">üëà</div>
                    <p>Select a slide or create a new one</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let presentation = {
            frontMatter: '',
            slides: []
        };
        let currentSlideIndex = null;
        let fileHandle = null; // Store file handle for direct saving

        // Load file using File System Access API
        async function loadFile() {
            try {
                if ('showOpenFilePicker' in window) {
                    // Use File System Access API
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'Markdown files',
                            accept: { 'text/markdown': ['.md'] }
                        }],
                        multiple: false
                    });
                    
                    fileHandle = handle;
                    const file = await handle.getFile();
                    const content = await file.text();
                    parsePresentation(content);
                    renderSlidesList();
                } else {
                    // Fallback to traditional file input
                    document.getElementById('file-input').click();
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error loading file:', err);
                    alert('Error loading file: ' + err.message);
                }
            }
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parsePresentation(e.target.result);
                    renderSlidesList();
                };
                reader.readAsText(file);
            }
        });

        // Parse markdown file
        function parsePresentation(content) {
            const lines = content.split('\n');
            let frontMatterEnd = -1;
            
            // Extract front matter (between --- markers)
            if (lines[0].trim() === '---') {
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '---') {
                        frontMatterEnd = i;
                        break;
                    }
                }
            }

            if (frontMatterEnd > 0) {
                presentation.frontMatter = lines.slice(0, frontMatterEnd + 1).join('\n');
                content = lines.slice(frontMatterEnd + 1).join('\n');
            }

            // Split by slide separator
            const slideContents = content.split(/\n---\n/);
            presentation.slides = slideContents
                .map(slideContent => parseSlide(slideContent.trim()))
                .filter(slide => slide !== null);
        }

        // Parse individual slide
        function parseSlide(content) {
            if (!content) return null;

            const slide = {
                class: '',
                headline: '',
                paragraph: '',
                bullets: [],
                quote: '',
                quoteCitation: '',
                imagePath: '',
                raw: content
            };

            const lines = content.split('\n');
            
            // Extract class
            const classMatch = content.match(/<!--\s*_class:\s*([^\s]+)\s*-->/);
            if (classMatch) {
                slide.class = classMatch[1];
            }

            // Extract headline
            const headlineMatch = content.match(/^#\s+(.+)$/m);
            if (headlineMatch) {
                slide.headline = headlineMatch[1];
            }

            // Extract bullets
            const bulletMatches = content.match(/^[-*]\s+(.+)$/gm);
            if (bulletMatches) {
                slide.bullets = bulletMatches.map(b => b.replace(/^[-*]\s+/, ''));
            }

            // Extract image
            const imageMatch = content.match(/!\[\]\(([^)]+)\)/);
            if (imageMatch) {
                slide.imagePath = imageMatch[1];
            }

            // Extract quote
            const quoteMatch = content.match(/^>\s+(.+)$/m);
            if (quoteMatch) {
                slide.quote = quoteMatch[1];
            }

            // Extract paragraph (text that's not headline, bullet, or quote)
            const textLines = lines.filter(line => {
                const trimmed = line.trim();
                return trimmed && 
                       !trimmed.startsWith('#') && 
                       !trimmed.startsWith('-') &&
                       !trimmed.startsWith('*') &&
                       !trimmed.startsWith('>') &&
                       !trimmed.startsWith('<!--') &&
                       !trimmed.startsWith('![]') &&
                       !trimmed.startsWith('<');
            });
            if (textLines.length > 0) {
                slide.paragraph = textLines.join('\n');
            }

            return slide;
        }

        // Render slides list
        function renderSlidesList() {
            const list = document.getElementById('slides-list');
            
            if (presentation.slides.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <p>No slides yet. Add one!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = presentation.slides.map((slide, index) => `
                <div class="slide-item ${index === currentSlideIndex ? 'active' : ''}" 
                     draggable="true"
                     data-index="${index}"
                     onclick="editSlide(${index})"
                     ondragstart="handleDragStart(event, ${index})"
                     ondragover="handleDragOver(event)"
                     ondragenter="handleDragEnter(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, ${index})"
                     ondragend="handleDragEnd(event)">
                    <div class="slide-item-number">Slide ${index + 1}</div>
                    <div class="slide-item-title">${slide.headline || '(No headline)'}</div>
                    <div class="slide-item-class">${slide.class || 'no class'}</div>
                </div>
            `).join('');
        }

        // Drag and drop handlers
        let draggedSlideIndex = null;

        function handleDragStart(event, index) {
            draggedSlideIndex = index;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(event) {
            const target = event.target.closest('.slide-item');
            if (target) {
                target.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            const target = event.target.closest('.slide-item');
            if (target) {
                target.classList.remove('drag-over');
            }
        }

        function handleDrop(event, dropIndex) {
            event.stopPropagation();
            event.preventDefault();

            const target = event.target.closest('.slide-item');
            if (target) {
                target.classList.remove('drag-over');
            }

            if (draggedSlideIndex !== null && draggedSlideIndex !== dropIndex) {
                // Move the slide in the array
                const draggedSlide = presentation.slides[draggedSlideIndex];
                presentation.slides.splice(draggedSlideIndex, 1);
                
                // Adjust drop index if needed
                const newIndex = draggedSlideIndex < dropIndex ? dropIndex - 1 : dropIndex;
                presentation.slides.splice(newIndex, 0, draggedSlide);

                // Update current slide index if needed
                if (currentSlideIndex === draggedSlideIndex) {
                    currentSlideIndex = newIndex;
                } else if (currentSlideIndex >= Math.min(draggedSlideIndex, dropIndex) && 
                           currentSlideIndex <= Math.max(draggedSlideIndex, dropIndex)) {
                    // Adjust currentSlideIndex if it's in the affected range
                    if (draggedSlideIndex < dropIndex && currentSlideIndex > draggedSlideIndex && currentSlideIndex <= dropIndex) {
                        currentSlideIndex--;
                    } else if (draggedSlideIndex > dropIndex && currentSlideIndex >= dropIndex && currentSlideIndex < draggedSlideIndex) {
                        currentSlideIndex++;
                    }
                }

                renderSlidesList();
            }

            return false;
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            
            // Remove drag-over class from all items
            document.querySelectorAll('.slide-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedSlideIndex = null;
        }

        // Edit slide
        function editSlide(index) {
            currentSlideIndex = index;
            renderSlidesList();
            renderEditor(presentation.slides[index]);
        }

        // Render editor
        function renderEditor(slide) {
            const isQuote = slide.class && slide.class.includes('quote');
            const hasImage = slide.class && slide.class.includes('image');
            const is2Col = slide.class && slide.class.includes('2col');

            const editorView = document.getElementById('editor-view');
            editorView.innerHTML = `
                <div class="editor-header">
                    <h2>Edit Slide ${currentSlideIndex + 1}</h2>
                    <div class="editor-actions">
                        <button onclick="saveSlide()">üíæ Save Slide</button>
                        <button class="delete" onclick="deleteSlide()">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <div class="editor-content">
                    ${is2Col ? '<div class="info-box">For two-column slides, the bullets will be automatically split into left and right columns.</div>' : ''}
                    
                    <div class="form-group">
                        <label>Template</label>
                        <select id="slide-class" onchange="updateEditorFields()">
                            <option value="template-bullets" ${slide.class === 'template-bullets' ? 'selected' : ''}>Bullets (White)</option>
                            <option value="template-bullets-2col" ${slide.class === 'template-bullets-2col' ? 'selected' : ''}>Bullets Two-Column (White)</option>
                            <option value="template-bullets-image" ${slide.class === 'template-bullets-image' ? 'selected' : ''}>Bullets with Image (White)</option>
                            <option value="gold-bullets" ${slide.class === 'gold-bullets' ? 'selected' : ''}>Bullets (Gold)</option>
                            <option value="gold-bullets-2col" ${slide.class === 'gold-bullets-2col' ? 'selected' : ''}>Bullets Two-Column (Gold)</option>
                            <option value="gold-bullets-image" ${slide.class === 'gold-bullets-image' ? 'selected' : ''}>Bullets with Image (Gold)</option>
                            <option value="gold-bullets-image-split" ${slide.class === 'gold-bullets-image-split' ? 'selected' : ''}>Bullets with Image Split (Gold/White)</option>
                            <option value="template-quote-headline" ${slide.class === 'template-quote-headline' ? 'selected' : ''}>Quote with Headline (White)</option>
                            <option value="gold-quote-headline" ${slide.class === 'gold-quote-headline' ? 'selected' : ''}>Quote with Headline (Gold)</option>
                            <option value="agenda" ${slide.class === 'agenda' ? 'selected' : ''}>Agenda</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Headline</label>
                        <input type="text" id="slide-headline" value="${slide.headline || ''}">
                    </div>

                    <div class="form-group" id="paragraph-group" style="display: ${isQuote ? 'none' : 'block'}">
                        <label>Non-bullet Text (optional)</label>
                        <textarea id="slide-paragraph" rows="3">${slide.paragraph || ''}</textarea>
                    </div>

                    <div class="form-group" id="bullets-group" style="display: ${isQuote ? 'none' : 'block'}">
                        <label>Bullet Points</label>
                        <div class="bullet-list" id="bullet-list">
                            ${slide.bullets.length > 0 
                                ? slide.bullets.map(bullet => `
                                    <div class="bullet-item">
                                        <input type="text" value="${bullet}">
                                        <button onclick="removeBullet(this)">‚úï</button>
                                    </div>
                                `).join('')
                                : `<div class="bullet-item">
                                    <input type="text" placeholder="Enter bullet point">
                                    <button onclick="removeBullet(this)">‚úï</button>
                                </div>`
                            }
                        </div>
                        <button class="add-bullet-btn" onclick="addBullet()">+ Add Bullet</button>
                    </div>

                    <div class="form-group" id="quote-group" style="display: ${isQuote ? 'block' : 'none'}">
                        <label>Quote Text</label>
                        <textarea id="slide-quote" rows="4">${slide.quote || ''}</textarea>
                    </div>

                    <div class="form-group" id="image-group" style="display: ${hasImage ? 'block' : 'none'}">
                        <label>Image Path</label>
                        <input type="text" id="slide-image" value="${slide.imagePath || ''}" placeholder="assets/image.jpg">
                    </div>

                    <div class="markdown-preview" id="preview"></div>
                </div>
            `;

            updatePreview();
        }

        function updateEditorFields() {
            const slideClass = document.getElementById('slide-class').value;
            const isQuote = slideClass.includes('quote');
            const hasImage = slideClass.includes('image');

            document.getElementById('paragraph-group').style.display = isQuote ? 'none' : 'block';
            document.getElementById('bullets-group').style.display = isQuote ? 'none' : 'block';
            document.getElementById('quote-group').style.display = isQuote ? 'block' : 'none';
            document.getElementById('image-group').style.display = hasImage ? 'block' : 'none';

            updatePreview();
        }

        function updatePreview() {
            const preview = document.getElementById('preview');
            if (!preview) return;

            const markdown = generateSlideMarkdown();
            preview.textContent = markdown;
        }

        function generateSlideMarkdown() {
            const slideClass = document.getElementById('slide-class')?.value || '';
            const headline = document.getElementById('slide-headline')?.value || '';
            const paragraph = document.getElementById('slide-paragraph')?.value || '';
            const imagePath = document.getElementById('slide-image')?.value || '';
            const quote = document.getElementById('slide-quote')?.value || '';
            
            const bulletInputs = document.querySelectorAll('#bullet-list input');
            const bullets = Array.from(bulletInputs)
                .map(input => input.value.trim())
                .filter(bullet => bullet !== '');

            let markdown = `<!-- _class: ${slideClass} -->\n`;
            
            if (headline) {
                markdown += `# ${headline}\n`;
            }

            const isQuote = slideClass.includes('quote');
            const is2Col = slideClass.includes('2col');

            if (isQuote) {
                if (quote) {
                    markdown += `> ${quote}\n`;
                }
            } else {
                if (paragraph) {
                    markdown += `\n${paragraph}\n`;
                }

                if (bullets.length > 0) {
                    markdown += '\n';
                    
                    if (is2Col) {
                        const midpoint = Math.ceil(bullets.length / 2);
                        const leftBullets = bullets.slice(0, midpoint);
                        const rightBullets = bullets.slice(midpoint);

                        markdown += '<div>\n\n';
                        leftBullets.forEach(bullet => {
                            markdown += `- ${bullet}\n`;
                        });
                        markdown += '\n</div>\n<div>\n\n';
                        rightBullets.forEach(bullet => {
                            markdown += `- ${bullet}\n`;
                        });
                        markdown += '\n</div>\n';
                    } else {
                        bullets.forEach(bullet => {
                            markdown += `- ${bullet}\n`;
                        });
                    }
                }
            }

            if (imagePath && slideClass.includes('image')) {
                markdown += `\n![](${imagePath})\n`;
            }

            return markdown;
        }

        function addBullet() {
            const bulletList = document.getElementById('bullet-list');
            const bulletItem = document.createElement('div');
            bulletItem.className = 'bullet-item';
            bulletItem.innerHTML = `
                <input type="text" placeholder="Enter bullet point">
                <button onclick="removeBullet(this)">‚úï</button>
            `;
            bulletList.appendChild(bulletItem);
            updatePreview();
        }

        function removeBullet(button) {
            const bulletList = document.getElementById('bullet-list');
            if (bulletList.children.length > 1) {
                button.parentElement.remove();
                updatePreview();
            }
        }

        // Save slide
        function saveSlide() {
            if (currentSlideIndex === null) return;

            const markdown = generateSlideMarkdown();
            presentation.slides[currentSlideIndex] = parseSlide(markdown);
            renderSlidesList();
            alert('Slide saved!');
        }

        // Delete slide
        function deleteSlide() {
            if (currentSlideIndex === null) return;
            if (!confirm('Delete this slide?')) return;

            presentation.slides.splice(currentSlideIndex, 1);
            currentSlideIndex = null;
            renderSlidesList();
            document.getElementById('editor-view').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üëà</div>
                    <p>Select a slide or create a new one</p>
                </div>
            `;
        }

        // Add new slide
        function addNewSlide() {
            const newSlide = {
                class: 'template-bullets',
                headline: '',
                paragraph: '',
                bullets: [],
                quote: '',
                quoteCitation: '',
                imagePath: '',
                raw: '<!-- _class: template-bullets -->\n# New Slide\n'
            };

            presentation.slides.push(newSlide);
            currentSlideIndex = presentation.slides.length - 1;
            renderSlidesList();
            renderEditor(newSlide);
        }

        // Save file
        async function saveFile() {
            let content = presentation.frontMatter;
            
            if (content && !content.endsWith('\n')) {
                content += '\n';
            }

            content += '\n';
            content += presentation.slides
                .map(slide => slide.raw || generateSlideMarkdown())
                .join('\n\n---\n\n');

            try {
                if (fileHandle && 'createWritable' in fileHandle) {
                    // Save directly to the original file
                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    alert('File saved successfully!');
                } else {
                    // Fallback to download
                    const blob = new Blob([content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'presentation.md';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (err) {
                console.error('Error saving file:', err);
                alert('Error saving file: ' + err.message);
            }
        }

        // Add input listeners for live preview
        document.addEventListener('input', function(e) {
            if (e.target.closest('.editor-content')) {
                updatePreview();
            }
        });
    </script>
</body>
</html>